<%
  session_number = @session.burst_id.match(/burst_(\d+)/)&.[](1) || @session.burst_id
%>

<div class="min-h-screen bg-black text-white" data-controller="image-viewer" 
     data-image-viewer-total-value="<%= @photos.length %>"
     data-image-viewer-session-id-value="<%= @session.burst_id %>">
  
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-gradient-to-b from-black to-black/80 backdrop-blur-sm border-b-2 border-red-700">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between py-4">
        <%= link_to "‚Üê Gallery", root_path, class: "text-yellow-500 hover:text-yellow-400" %>
        <h2 class="text-2xl font-bold text-yellow-500">Session <%= session_number %></h2>
        <div class="flex gap-2">
          <% if @prev_session %>
            <%= link_to "‚Üê Prev", gallery_path(@prev_session), 
                class: "px-4 py-2 bg-red-900/50 text-white rounded hover:bg-red-800" %>
          <% end %>
          <% if @next_session %>
            <%= link_to "Next ‚Üí", gallery_path(@next_session), 
                class: "px-4 py-2 bg-red-900/50 text-white rounded hover:bg-red-800" %>
          <% end %>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main Image Viewer -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <!-- Main Image -->
      <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-4">
        <div class="aspect-[4/3] flex items-center justify-center">
          <% @photos.each_with_index do |photo, index| %>
            <div data-image-viewer-target="image" 
                 data-index="<%= index %>"
                 class="<%= index == 0 ? '' : 'hidden' %> w-full h-full">
              <% if photo.image.attached? %>
                <%= image_tag rails_blob_url(photo.image.variant(:large)), 
                              alt: "Photo #{index + 1}",
                              class: "w-full h-full object-contain cursor-pointer",
                              data: { action: "click->image-viewer#next", photo_id: photo.id } %>
              <% else %>
                <%= image_tag photo_path(path: photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')), 
                              alt: "Photo #{index + 1}",
                              class: "w-full h-full object-contain cursor-pointer",
                              data: { action: "click->image-viewer#next", photo_id: photo.id } %>
              <% end %>
            </div>
          <% end %>
        </div>
        
        <!-- Navigation Controls -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-black/70 px-6 py-3 rounded-full">
          <button data-action="click->image-viewer#previous" 
                  class="text-white hover:text-yellow-500 text-2xl">‚Üê</button>
          <span class="text-white" data-image-viewer-target="counter">1 / <%= @photos.length %></span>
          <button data-action="click->image-viewer#next" 
                  class="text-white hover:text-yellow-500 text-2xl">‚Üí</button>
        </div>
        
        <!-- Hero Selection Button -->
        <%= form_with url: update_hero_gallery_path(@session.burst_id), 
                      data: { turbo_frame: "_top" },
                      class: "absolute top-4 right-4" do |f| %>
          <%= hidden_field_tag :photo_id, @photos.first&.id, data: { image_viewer_target: "heroInput" } %>
          <%= f.submit "‚òÜ Select as Hero", 
                       data: { image_viewer_target: "heroButton" },
                       class: "px-4 py-2 bg-yellow-600/80 text-black font-bold rounded hover:bg-yellow-500 cursor-pointer" %>
        <% end %>
      </div>
      
      <!-- Email Collection -->
      <div class="bg-gray-900 rounded-lg p-6 mb-4">
        <% if @sitting&.email.present? %>
          <div class="flex items-center justify-between">
            <div class="text-green-500">
              ‚úì <%= @sitting.name || 'No name' %> - <%= @sitting.email %>
            </div>
            <button data-action="click->image-viewer#showEmailForm" 
                    class="text-yellow-500 hover:text-yellow-400">Edit</button>
          </div>
        <% else %>
          <button data-action="click->image-viewer#showEmailForm" 
                  class="px-4 py-2 bg-yellow-600 text-black font-bold rounded hover:bg-yellow-500">
            üìß Add Email
          </button>
        <% end %>
        
        <div data-image-viewer-target="emailForm" class="hidden mt-4">
          <%= form_with url: save_email_gallery_path(@session.burst_id), 
                        data: { turbo_frame: "_top" } do |f| %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <%= f.text_field :name, 
                               placeholder: "Name (optional)",
                               value: @sitting&.name,
                               class: "px-4 py-2 bg-black border border-gray-700 rounded text-white" %>
              <%= f.email_field :email, 
                                placeholder: "Email address",
                                value: @sitting&.email,
                                required: true,
                                class: "px-4 py-2 bg-black border border-gray-700 rounded text-white" %>
            </div>
            <div class="mt-4 flex gap-2">
              <%= f.submit "Save", class: "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500 cursor-pointer" %>
              <button type="button" 
                      data-action="click->image-viewer#hideEmailForm"
                      class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">
                Cancel
              </button>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Thumbnails -->
      <div class="bg-gray-900 rounded-lg p-4">
        <div class="flex gap-2 overflow-x-auto pb-2">
          <% @photos.each_with_index do |photo, index| %>
            <button data-action="click->image-viewer#goToImage"
                    data-index="<%= index %>"
                    data-image-viewer-target="thumbnail"
                    class="flex-shrink-0 w-20 h-20 rounded overflow-hidden border-2 <%= index == 0 ? 'border-yellow-500' : 'border-gray-700' %> hover:border-yellow-400 transition-colors">
              <% if photo.image.attached? %>
                <%= image_tag rails_blob_url(photo.image.variant(:thumb)), 
                              alt: "Thumbnail #{index + 1}",
                              loading: "lazy",
                              class: "w-full h-full object-cover" %>
              <% else %>
                <%= image_tag photo_path(path: photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', ''), variant: 'thumb'), 
                              alt: "Thumbnail #{index + 1}",
                              loading: "lazy",
                              class: "w-full h-full object-cover" %>
              <% end %>
            </button>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>