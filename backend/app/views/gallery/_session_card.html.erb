<%
  # Get hero photo efficiently (already loaded via includes)
  hero_photo = session.sittings.first&.hero_photo
  
  # If no sitting hero, we need to fetch a middle photo (only when needed)
  unless hero_photo
    hero_photo = session.photos.find_by(position: session.photo_count / 2) || session.photos.first
  end
  
  # Use pre-loaded face count from controller
  has_faces = @face_counts && @face_counts[session.id].to_i > 0
  
  # Only look for face photo if we have faces
  face_photo = has_faces ? hero_photo : nil
  
  # Session number
  session_number = sprintf('%03d', session.session_number || session.burst_id.scan(/\d+/).first.to_i)
%>

<%= link_to gallery_path(session.burst_id), 
            class: "session-card block bg-black border-2 border-red-700 rounded-lg overflow-hidden hover:border-yellow-500 transition-all duration-300 transform hover:scale-105",
            data: { 
              session_id: session.id,
              burst_id: session.burst_id,
              has_faces: has_faces 
            } do %>
  
  <div class="thumbnail-container relative aspect-[3/4] bg-gradient-to-b from-red-900/20 to-black overflow-hidden">
    <!-- Regular thumbnail (shown by default) -->
    <div class="regular-thumbnail w-full h-full">
      <% if hero_photo&.image&.attached? %>
        <%= image_tag rails_blob_url(hero_photo.image.variant(:thumb)), 
                      alt: "Sitting #{session_number}",
                      class: "w-full h-full object-cover" %>
      <% elsif hero_photo %>
        <%= image_tag photo_path(path: hero_photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')), 
                      alt: "Sitting #{session_number}",
                      loading: "lazy",
                      class: "w-full h-full object-cover" %>
      <% else %>
        <div class="flex items-center justify-center h-full text-gray-600">
          No Image
        </div>
      <% end %>
    </div>
    
    <!-- Face crop thumbnail (shown in face mode) -->
    <div class="face-thumbnail w-full h-full hidden">
      <% if has_faces && face_photo&.image&.attached? %>
        <% face_url = face_photo.face_crop_url(size: 300) %>
        <% if face_url.present? %>
          <%= image_tag face_url, 
                        alt: "Sitting #{session_number}",
                        loading: "lazy",
                        class: "w-full h-full object-cover" %>
        <% else %>
          <!-- Fallback to regular thumbnail if face crop fails -->
          <%= image_tag rails_blob_url(face_photo.image.variant(:thumb)), 
                        alt: "Sitting #{session_number}",
                        loading: "lazy",
                        class: "w-full h-full object-cover" %>
        <% end %>
      <% elsif hero_photo&.image&.attached? %>
        <!-- No face data, show regular thumbnail -->
        <%= image_tag rails_blob_url(hero_photo.image.variant(:thumb)), 
                      alt: "Sitting #{session_number}",
                      loading: "lazy",
                      class: "w-full h-full object-cover" %>
      <% elsif hero_photo %>
        <%= image_tag photo_path(path: hero_photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')), 
                      alt: "Sitting #{session_number}",
                      loading: "lazy",
                      class: "w-full h-full object-cover" %>
      <% else %>
        <div class="flex items-center justify-center h-full text-gray-600">
          No Image
        </div>
      <% end %>
    </div>
  </div>
  
  <div class="session-info p-4 bg-gradient-to-b from-red-900/10 to-black/50">
    <h4 class="text-lg font-bold text-yellow-500 uppercase mb-2">
      Sitting <%= session_number %>
    </h4>
    <p class="text-white text-sm mb-1">
      <%= session.started_at.in_time_zone('America/Los_Angeles').strftime("%-l:%M %p") %>
    </p>
    <p class="text-red-500 text-sm font-semibold">
      <%= session.photo_count %> photos
      <% if session.ended_at && session.started_at %>
        <span class="text-gray-400">â€¢ <%= ((session.ended_at - session.started_at) / 60).round %>m</span>
      <% end %>
    </p>
    
    <% if current_user&.admin? %>
      <div class="mt-2 flex gap-1">
        <% if session.sittings.any? %>
          <span class="text-xs bg-green-800 px-1 rounded">âœ“ sitting</span>
        <% end %>
        <% if has_faces %>
          <span class="text-xs bg-blue-800 px-1 rounded">ðŸ‘¤ faces</span>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>