<% content_for :page_title, "Admin Dashboard" %>
<% content_for :page_subtitle, "OKNOTOK Shock Collar Portraits - Burning Man 2025" %>

<%= render 'shared/oknotok_admin_layout' do %>
  <!-- Quick Stats Grid -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= @stats[:total_sessions] %></div>
      <div class="text-red-400 text-sm">Total Sessions</div>
    </div>
    
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= number_with_delimiter(@stats[:total_photos]) %></div>
      <div class="text-red-400 text-sm">Total Photos</div>
    </div>
    
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= @stats[:total_sittings] %></div>
      <div class="text-red-400 text-sm">Email Collected</div>
    </div>
    
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= @stats[:sessions_with_sittings] %></div>
      <div class="text-red-400 text-sm">Sessions w/ Email</div>
    </div>
    
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= @stats[:sessions_without_sittings] %></div>
      <div class="text-red-400 text-sm">Sessions w/o Email</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Photo Management -->
    <div class="oknotok-card">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">üì∏ Photo Management</h3>
      <div class="space-y-3">
        <%= link_to admin_thumbnails_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Thumbnails Editor</div>
          <div class="text-sm text-gray-400">Select heroes, reject photos, split sessions</div>
        <% end %>
        <%= link_to gallery_index_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Gallery View</div>
          <div class="text-sm text-gray-400">Browse all photos by session</div>
        <% end %>
      </div>
    </div>

    <!-- Processing Tools -->
    <div class="oknotok-card">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">‚öôÔ∏è Processing Tools</h3>
      <div class="space-y-3">
        <%= link_to admin_face_detection_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Face Detection</div>
          <div class="text-sm text-gray-400">Process photos for face rectangles</div>
        <% end %>
        <%= link_to admin_queue_status_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Job Queue Status</div>
          <div class="text-sm text-gray-400">Monitor background processing</div>
        <% end %>
      </div>
    </div>

    <!-- Data & Reports -->
    <div class="oknotok-card">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">üìä Data & Reports</h3>
      <div class="space-y-3">
        <%= link_to stats_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Statistics Dashboard</div>
          <div class="text-sm text-gray-400">Charts and analytics</div>
        <% end %>
        <%= link_to admin_export_emails_path, format: :csv, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Export Emails CSV</div>
          <div class="text-sm text-gray-400"><%= @stats[:total_sittings] %> unique emails collected</div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sessions by Day -->
  <div class="oknotok-card mb-8">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">üìÖ Sessions by Day</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <% @days.each do |day| %>
        <div class="bg-gray-800 border border-red-600 rounded p-4">
          <div class="font-bold text-yellow-500 capitalize"><%= day.day_name %></div>
          <div class="text-sm text-red-400"><%= day.date.strftime('%b %d') %></div>
          <div class="text-2xl font-bold text-white mt-2"><%= day.photo_sessions.visible.count %></div>
          <div class="text-sm text-gray-400">sessions</div>
          <div class="text-sm text-gray-500 mt-1">
            <%= day.photo_sessions.visible.sum { |ps| ps.photo_count || 0 } %> photos
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="oknotok-card">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-yellow-500">üìß Recent Email Collections</h2>
      <div class="flex gap-2">
        <%= link_to "View All", admin_sittings_path, 
            class: "oknotok-button-secondary text-sm" %>
        <%= link_to "Export CSV", admin_export_emails_path(format: :csv), 
            class: "oknotok-button-primary text-sm" %>
      </div>
    </div>
    
    <% if @recent_sittings.any? %>
      <div class="overflow-x-auto">
        <table class="oknotok-table">
          <thead>
            <tr>
              <th class="py-2">Session</th>
              <th class="py-2">Day</th>
              <th class="py-2">Name</th>
              <th class="py-2">Email</th>
              <th class="py-2">Notes</th>
              <th class="py-2">Time</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_sittings.each do |sitting| %>
              <tr class="hover:bg-gray-800">
                <td class="py-2 text-white">
                  <% if sitting.photo_session.burst_id.start_with?('placeholder_') %>
                    <span class="text-gray-500">CSV Import</span>
                  <% else %>
                    #<%= sitting.photo_session.session_number %>
                  <% end %>
                </td>
                <td class="py-2 text-white capitalize">
                  <%= sitting.photo_session.session_day.day_name %>
                </td>
                <td class="py-2 text-white"><%= sitting.name || '-' %></td>
                <td class="py-2 text-yellow-500"><%= sitting.email %></td>
                <td class="py-2 text-gray-400 text-sm"><%= truncate(sitting.notes || '-', length: 30) %></td>
                <td class="py-2 text-gray-400 text-sm">
                  <%= sitting.created_at.strftime('%b %d %H:%M') %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-400">No email collections yet.</p>
    <% end %>
  </div>

  <!-- Admin Tools -->
  <% if current_user&.superadmin? %>
    <div class="mt-8 p-6 bg-gradient-to-r from-red-900 to-yellow-900 border border-red-600 rounded-lg">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">üîß Superadmin Tools</h3>
      <div class="flex flex-wrap gap-4">
        <%= link_to "Manage Admins", admin_invites_path, 
            class: "px-4 py-2 bg-black text-yellow-500 hover:bg-gray-900 rounded transition" %>
        <%= link_to "Bulk Invite Users", "#", 
            onclick: "if(confirm('Run rails emails:bulk_invite to send invitations to all collected emails')) { alert('Run this command in terminal'); } return false;",
            class: "px-4 py-2 bg-black text-yellow-500 hover:bg-gray-900 rounded transition" %>
      </div>
    </div>
  <% end %>
<% end %>