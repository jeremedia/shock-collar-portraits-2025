<% cache ["stats_page_v14", @stats_version] do %>
<%
  # Prepare data for JavaScript
  stats_data = {
    dailyDetails: @daily_details,
    dailySessionTimelines: @daily_session_timelines,
    canonSessions: @canon_sessions,
    iphoneSessions: @iphone_sessions,
    photoDistribution: @photo_distribution
  }
%>

<% content_for :title, "OKNOTOK Statistics Dashboard" %>


<div class="bg-black text-white p-8" data-controller="stats">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2 text-yellow-500">OKNOTOK Shock Collar Portraits</h1>
      <p class="text-2xl text-red-400">2025 Statistics</p>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500 whitespace-nowrap"><%= @total_sessions %></div>
        <div class="text-red-400">Total Sessions</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500 whitespace-nowrap"><%= number_with_delimiter(@total_photos) %></div>
        <div class="text-red-400">Total Photos</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500 whitespace-nowrap"><%= (@total_faces_detected || 0) %></div>
        <div class="text-red-400">Faces Detected</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500 whitespace-nowrap"><%= @total_sittings %></div>
        <div class="text-red-400">Sittings Recorded</div>
      </div>
    </div>

    <!-- Secondary Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-2xl font-bold text-yellow-500 whitespace-nowrap"><%= number_with_precision(@avg_photos_per_session, precision: 1, strip_insignificant_zeros: true) %></div>
        <div class="text-red-400 text-sm">Avg Photos/Session</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-2xl font-bold text-yellow-500 whitespace-nowrap"><%= number_with_precision(@rejection_rate, precision: 1, strip_insignificant_zeros: true) %>%</div>
        <div class="text-red-400 text-sm">Rejection Rate</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-2xl font-bold text-yellow-500 whitespace-nowrap"><%= number_with_precision(@avg_duration, precision: 1, strip_insignificant_zeros: true) %> min</div>
        <div class="text-red-400 text-sm">Avg Duration</div>
      </div>
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <div class="text-2xl font-bold text-yellow-500 whitespace-nowrap"><%= number_with_precision(@total_storage_gb, precision: 1, strip_insignificant_zeros: true) %> GB</div>
        <div class="text-red-400 text-sm">Est. Storage</div>
      </div>
    </div>

    <!-- Daily Activity Overview -->
    <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-8">
      <h2 class="text-xl font-bold mb-4 text-yellow-500">Daily Activity (Monday - Friday)</h2>
      <div style="position: relative; height: 300px;">
        <canvas id="dailyActivityChart"></canvas>
      </div>
    </div>

    <!-- Daily Session Timelines -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4 text-yellow-500">Daily Session Timelines (3-5pm PDT Window)</h2>
      
      <!-- Monday -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-lg font-bold text-yellow-500">Monday, August 25</h3>
          <div class="text-sm text-gray-400">
            <% monday = @daily_session_timelines['2025-08-25'] || {} %>
            Sessions: <%= monday[:total_sessions] || 0 %> • Photos: <%= monday[:total_photos] || 0 %>
          </div>
        </div>
        <div style="position: relative; height: 200px;">
          <canvas id="mondayChart"></canvas>
        </div>
      </div>

      <!-- Tuesday -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-lg font-bold text-yellow-500">Tuesday, August 26</h3>
          <div class="text-sm text-gray-400">
            <% tuesday = @daily_session_timelines['2025-08-26'] || {} %>
            Sessions: <%= tuesday[:total_sessions] || 0 %> • Photos: <%= tuesday[:total_photos] || 0 %>
          </div>
        </div>
        <div style="position: relative; height: 200px;">
          <canvas id="tuesdayChart"></canvas>
        </div>
      </div>

      <!-- Wednesday -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-lg font-bold text-yellow-500">Wednesday, August 27</h3>
          <div class="text-sm text-gray-400">
            <% wednesday = @daily_session_timelines['2025-08-27'] || {} %>
            Sessions: <%= wednesday[:total_sessions] || 0 %> • Photos: <%= wednesday[:total_photos] || 0 %>
          </div>
        </div>
        <div style="position: relative; height: 200px;">
          <canvas id="wednesdayChart"></canvas>
        </div>
      </div>

      <!-- Thursday -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-lg font-bold text-yellow-500">Thursday, August 28</h3>
          <div class="text-sm text-gray-400">
            <% thursday = @daily_session_timelines['2025-08-28'] || {} %>
            Sessions: <%= thursday[:total_sessions] || 0 %> • Photos: <%= thursday[:total_photos] || 0 %>
          </div>
        </div>
        <div style="position: relative; height: 200px;">
          <canvas id="thursdayChart"></canvas>
        </div>
      </div>

      <!-- Friday -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-lg font-bold text-yellow-500">Friday, August 29</h3>
          <div class="text-sm text-gray-400">
            <% friday = @daily_session_timelines['2025-08-29'] || {} %>
            Sessions: <%= friday[:total_sessions] || 0 %> • Photos: <%= friday[:total_photos] || 0 %>
          </div>
        </div>
        <div style="position: relative; height: 200px;">
          <canvas id="fridayChart"></canvas>
        </div>
      </div>

      <!-- All Days Combined -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-bold mb-3 text-yellow-500">All Days Combined (Smoothed Averages)</h3>
        <div style="position: relative; height: 480px;">
          <canvas id="combinedTimelineChart"></canvas>
        </div>
        <div class="mt-2 text-xs text-gray-500">
          10-minute buckets of sessions per day between 3:00–5:00.
        </div>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Camera Types -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <h2 class="text-xl font-bold mb-4 text-yellow-500">Camera Types</h2>
        <div style="position: relative; height: 250px;">
          <canvas id="cameraChart"></canvas>
        </div>
      </div>

      <!-- Photo Distribution -->
      <div class="bg-gray-900 border border-red-600 rounded-lg p-4">
        <h2 class="text-xl font-bold mb-4 text-yellow-500">Photos Per Session Distribution</h2>
        <div style="position: relative; height: 250px;">
          <canvas id="distributionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Sessions Table -->
    <div class="bg-gray-900 border border-red-600 rounded-lg p-4 mb-8">
      <h2 class="text-xl font-bold mb-4 text-yellow-500">Top Sessions by Photo Count</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <% @top_sessions.each_with_index do |session, index| %>
          <a href="/session/<%= session[:id] %>/photo/1" class="flex justify-between items-center py-2 border-b border-gray-800 hover:bg-gray-800 transition-colors">
            <div class="flex items-center">
              <span class="text-gray-500 mr-3">#<%= index + 1 %></span>
              <div>
                <div class="font-semibold text-white hover:text-yellow-400">Session <%= session[:id] %></div>
                <div class="text-sm text-gray-400"><%= session[:started_at].strftime("%B %d, %I:%M %p") %></div>
              </div>
            </div>
            <span class="text-xl font-bold text-yellow-500"><%= session[:count] %></span>
          </a>
        <% end %>
      </div>
    </div>


  </div>
</div>

<!-- Chart.js Canvas Sizing Fix -->
<style>
  canvas {
    box-sizing: border-box;
  }
</style>

<!-- Admin-only cache version footer -->
<% if current_user&.admin? %>
  <div class="text-xs text-gray-500 text-center my-4">
    Stats cache version: <span class="font-mono"><%= @stats_version %></span>
  </div>
<% end %>

<!-- Stats Data for JavaScript (cached JSON) -->
<script>
  window.statsData = <%= @stats_json.html_safe %>;
  // console.log('statsData version', '<%= @stats_version %>')
  </script>
<% end %>
