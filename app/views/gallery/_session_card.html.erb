<%
  # Get hero photo directly from PhotoSession (not from unreliable Sitting model)
  hero_photo = session.hero_photo
  has_hero_selection = session.hero_photo_id.present?

  # Use pre-loaded middle photo if no hero selected
  display_photo = hero_photo || @middle_photos[session.id]

  # Use pre-loaded face count from controller
  has_faces = @face_counts && @face_counts[session.id].to_i > 0

  # Only look for face photo if we have faces
  face_photo = has_faces ? display_photo : nil

  # Use actual session ID
  session_id = session.id
%>

<%= link_to session_path(session.id),
            class: "session-card block bg-black border-2 border-red-700 rounded-lg overflow-hidden hover:border-yellow-500 transition-all duration-300 transform hover:scale-105",
            data: {
              session_id: session.id,
              burst_id: session.burst_id,
              has_faces: has_faces
            } do %>
  
  <div class="thumbnail-container relative aspect-[3/4] bg-gradient-to-b from-red-900/20 to-black overflow-hidden"
       data-controller="lazy-images">

    <!-- Crown emoji for hero selections -->
    <% if has_hero_selection %>
      <div class="absolute top-2 right-2 z-10 text-2xl" title="Hero Photo Selected">
        ðŸ‘‘
      </div>
    <% end %>

    <!-- Regular thumbnail (shown by default) -->
    <div class="regular-thumbnail w-full h-full">
      <% if display_photo&.image&.attached? %>
        <% cache ["session_thumb_url", display_photo.id, display_photo.updated_at] do %>
          <img data-lazy-images-target="image"
               data-src="<%= display_photo.image.variant(:thumb).url %>"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3C/svg%3E"
               alt="Sitting <%= session_id %>"
               style="opacity: 0.3;"
               class="w-full h-full object-cover" />
        <% end %>
      <% elsif display_photo %>
        <img data-lazy-images-target="image"
             data-src="<%= photo_path(path: display_photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')) %>"
             alt="Sitting <%= session_number %>"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3C/svg%3E"
             style="opacity: 0.3;"
             class="w-full h-full object-cover" />
      <% else %>
        <div class="flex items-center justify-center h-full text-gray-600">
          No Image
        </div>
      <% end %>
    </div>
    
    <!-- Face crop thumbnail (shown in face mode) -->
    <div class="face-thumbnail w-full h-full hidden">
      <% if has_faces && face_photo&.image&.attached? %>
        <% cache ["session_face_url", face_photo.id, face_photo.updated_at] do %>
          <% face_url = face_photo.face_crop_url(size: 300) %>
          <% if face_url.present? %>
            <img data-lazy-images-target="image"
                 data-src="<%= face_url %>"
                 alt="Sitting <%= session_id %>"
                 style="opacity: 0;"
                 class="w-full h-full object-cover bg-gray-800" />
          <% else %>
            <!-- Fallback to regular thumbnail if face crop fails -->
            <img data-lazy-images-target="image"
                 data-src="<%= face_photo.image.variant(:thumb).url %>"
                 alt="Sitting <%= session_id %>"
                 style="opacity: 0;"
                 class="w-full h-full object-cover bg-gray-800" />
          <% end %>
        <% end %>
      <% elsif display_photo&.image&.attached? %>
        <!-- No face data, show regular thumbnail -->
        <% cache ["session_thumb_url_face_fallback", display_photo.id, display_photo.updated_at] do %>
          <img data-lazy-images-target="image"
               data-src="<%= display_photo.image.variant(:thumb).url %>"
               alt="Sitting <%= session_id %>"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3C/svg%3E"
               style="opacity: 0.3;"
               class="w-full h-full object-cover" />
        <% end %>
      <% elsif display_photo %>
        <img data-lazy-images-target="image"
             data-src="<%= photo_path(path: display_photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')) %>"
             alt="Sitting <%= session_number %>"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3C/svg%3E"
             style="opacity: 0.3;"
             class="w-full h-full object-cover" />
      <% else %>
        <div class="flex items-center justify-center h-full text-gray-600">
          No Image
        </div>
      <% end %>
    </div>
  </div>
  
  <div class="session-info p-4 bg-gradient-to-b from-red-900/10 to-black/50">
    <h4 class="text-lg font-bold text-yellow-500 uppercase mb-1">
      Sitting <%= session_id %> - <%= session.started_at.in_time_zone('America/Los_Angeles').strftime("%-l:%M %p") %>
    </h4>
    <p class="text-white text-sm">
      <%= session.photo_count %> photos
    </p>

    <!-- Hidden additional info for potential future use -->
    <div class="hidden">
      <% if session.ended_at && session.started_at %>
        <span class="text-gray-400">â€¢ <%= ((session.ended_at - session.started_at) / 60).round %>m</span>
      <% end %>

      <% if current_user&.admin? %>
        <div class="mt-2 flex gap-1">
          <% if session.sittings.any? %>
            <span class="text-xs bg-green-800 px-1 rounded">âœ“ sitting</span>
          <% end %>
          <% if has_faces %>
            <span class="text-xs bg-blue-800 px-1 rounded">ðŸ‘¤ faces</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>