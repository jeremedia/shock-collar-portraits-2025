<%
  session_number = @session.burst_id.match(/burst_(\d+)/)&.[](1) || @session.burst_id
  day_name = @session.session_day.day_name if @session.session_day

  # Get first photo's timestamp in PST
  first_photo = @photos.first
  if first_photo&.photo_taken_at
    # photo_taken_at returns UTC, convert to PST for display
    photo_time_pst = first_photo.photo_taken_at.in_time_zone('America/Los_Angeles')
    time_display = photo_time_pst.strftime('%l:%M %p PST').strip
  end

  # Dynamic page title for browser history
  photo_position = @initial_index + 1
  title_parts = []
  title_parts << day_name.capitalize if day_name
  title_parts << "Session #{session_number}"
  title_parts << "Photo #{photo_position}/#{@photos.length}"
  page_title = title_parts.join(" - ")
%>

<% content_for :title, page_title %>

<!-- Lightroom-style Photo Viewer: Full viewport, no vertical scrolling -->
<div class="fixed inset-0 z-50 bg-black text-white flex flex-col overflow-hidden" data-controller="image-viewer"
     data-image-viewer-total-value="<%= @photos.length %>"
     data-image-viewer-session-id-value="<%= @session.id %>"
     data-image-viewer-show-rejected-value="<%= @show_rejected %>"
     data-image-viewer-initial-index-value="<%= @initial_index %>"
     data-image-viewer-prev-session-value="<%= @prev_session_id ? session_path(@prev_session_id) : '' %>"
     data-image-viewer-next-session-value="<%= @next_session_id ? session_path(@next_session_id) : '' %>"
     data-image-viewer-burst-id-value="<%= @session.burst_id %>">
  
  <!-- Fixed Header -->
  <header class="flex-shrink-0 bg-black/90 backdrop-blur-sm border-b border-red-700/50">
    <div class="px-6 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <%= link_to "‚Üê Gallery", root_path, class: "text-yellow-500 hover:text-yellow-400 font-medium" %>
          <div class="text-gray-400">|</div>
          <h2 class="text-lg font-bold text-yellow-500">
            <%= day_name&.capitalize %><%= ", " if day_name %>Sitting <%= session_number %>
            <% if time_display %>
              <span class="text-sm font-normal text-gray-400 ml-2">(<%= time_display %>)</span>
            <% end %>
          </h2>
        </div>
        
        <div class="flex items-center gap-3">
          <!-- Session Navigation -->
          <div class="flex gap-1">
            <% if @prev_session_id %>
              <%= link_to "‚Üê Prev", session_path(@prev_session_id),
                  class: "px-3 py-1 text-sm bg-red-900/30 text-white rounded hover:bg-red-800/50 transition-colors whitespace-nowrap" %>
            <% end %>
            <% if @next_session_id %>
              <%= link_to "Next ‚Üí", session_path(@next_session_id),
                  class: "px-3 py-1 text-sm bg-red-900/30 text-white rounded hover:bg-red-800/50 transition-colors whitespace-nowrap" %>
            <% end %>
          </div>

          <!-- Hide Heroes Checkbox (Admin Only) -->
          <% if current_user.admin? %>
            <%= form_with url: toggle_hide_heroes_gallery_index_path, method: :post, local: false, data: { turbo_frame: "_top" }, class: "flex items-center gap-2" do |f| %>
              <%= check_box_tag :hide_heroes, 'true', @hide_heroes,
                  id: "viewer-hide-heroes-toggle",
                  onchange: "this.form.requestSubmit()",
                  class: "w-4 h-4 rounded border-red-700 bg-black text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0" %>
              <label for="viewer-hide-heroes-toggle" class="text-yellow-500 text-sm font-semibold cursor-pointer select-none whitespace-nowrap">
                Hide Heroes
              </label>
            <% end %>
          <% end %>

          <!-- Hide Session Button (Admin Only) -->
          <% if current_user.admin? %>
            <%= form_with url: hide_session_gallery_path(@session.id), 
                          method: :patch,
                          data: { 
                            turbo_frame: "_top"
                          },
                          local: true do |f| %>
              <%= f.submit "üóÇÔ∏è Hide Session", 
                           data: { 
                             action: "click->image-viewer#confirmHideSession",
                             session_number: session_number,
                             photo_count: @photos.length 
                           },
                           class: "px-3 py-1 text-sm bg-gray-700/70 text-gray-300 rounded hover:bg-red-700/70 hover:text-white transition-colors cursor-pointer whitespace-nowrap" %>
            <% end %>
          <% end %>
          
          <!-- Toggle Rejected Photos -->
          <% if @rejected_count > 0 %>
            <%= link_to gallery_path(@session.burst_id, show_rejected: !@show_rejected), 
                class: "px-3 py-1 text-sm bg-gray-700/50 text-gray-300 rounded hover:bg-gray-600/50 transition-colors whitespace-nowrap" do %>
              <%= @show_rejected ? "Hide" : "Show" %> Rejected (<%= @rejected_count %>)
            <% end %>
          <% end %>
          
        </div>
      </div>
    </div>
  </header>
  
  <!-- Flexible Photo Viewport -->
  <main class="flex-1 min-h-0 relative bg-black overflow-hidden flex" data-image-viewer-target="mainContainer">
    <!-- Photo Container -->
    <div class="flex-1 relative" data-image-viewer-target="photoContainer">
      <!-- Images -->
      <% @photos.each_with_index do |photo, index| %>
      <div data-image-viewer-target="image"
           data-index="<%= index %>"
           data-face-data="<%= photo.face_data.to_json if photo.face_data.present? %>"
           data-original-path="<%= photo.original_path %>"
           data-exif-data="<%= photo.exif_data.to_json if photo.exif_data.present? %>"
           <% if photo.image.attached? %>
             data-large-url="<%= rails_blob_url(photo.image.variant(:large)) %>"
           <% else %>
             data-fallback-url="<%= photo_path(path: photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')) %>"
           <% end %>
           data-photo-id="<%= photo.id %>"
           class="<%= index == @initial_index ? '' : 'hidden' %> w-full h-full image-container">
        <div class="relative w-full h-full" data-image-viewer-target="imageWrapper">
          <% if index == @initial_index %>
            <!-- Only load the initially visible image -->
            <% if photo.image.attached? %>
              <%= image_tag rails_blob_url(photo.image.variant(:large)), 
                            alt: "Photo #{index + 1}",
                            class: "w-full h-full object-contain cursor-pointer",
                            data: { action: "click->image-viewer#next", photo_id: photo.id } %>
            <% else %>
              <%= image_tag photo_path(path: photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', '')), 
                            alt: "Photo #{index + 1}",
                            class: "w-full h-full object-contain cursor-pointer",
                            data: { action: "click->image-viewer#next", photo_id: photo.id } %>
            <% end %>
          <% else %>
            <!-- Placeholder for lazy loading -->
            <div class="w-full h-full flex items-center justify-center">
              <div class="text-gray-500">Loading...</div>
            </div>
          <% end %>
          <!-- Face Rectangle Overlay -->
          <div class="absolute inset-0 pointer-events-none hidden" data-image-viewer-target="faceOverlay"></div>
        </div>
      </div>
      <% end %>

      <!-- Left Navigation -->
      <button data-action="click->image-viewer#previous"
              class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/50 hover:bg-black/70 border border-white/20 rounded-full flex items-center justify-center text-white hover:text-yellow-500 text-xl transition-colors z-10">
        ‚Üê
      </button>

      <!-- Right Navigation -->
      <button data-action="click->image-viewer#next"
              class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/50 hover:bg-black/70 border border-white/20 rounded-full flex items-center justify-center text-white hover:text-yellow-500 text-xl transition-colors z-10">
        ‚Üí
      </button>
    </div>

    <!-- EXIF Panel -->
    <div data-image-viewer-target="exifPanel"
         class="hidden w-80 bg-gray-900/95 backdrop-blur-sm border-l border-red-700/50 overflow-y-auto">
      <!-- Panel Header -->
      <div class="bg-gradient-to-r from-red-900/30 to-transparent border-b border-red-700/50 px-4 py-3">
        <div class="flex justify-between items-center">
          <h3 class="text-yellow-500 font-bold text-lg flex items-center gap-2">
            <span class="text-red-400">üìä</span>
            EXIF Data
          </h3>
          <button data-action="click->image-viewer#toggleExifPanel"
                  class="w-8 h-8 bg-black/30 hover:bg-red-700/50 border border-red-700/30 hover:border-red-500 rounded-full flex items-center justify-center text-gray-400 hover:text-white transition-colors">
            ‚úï
          </button>
        </div>
      </div>

      <!-- Panel Content -->
      <div class="p-4">
        <div data-image-viewer-target="exifContent" class="space-y-1">
          <!-- EXIF data will be populated here -->
          <div class="text-gray-500 text-center py-8">Press X to show EXIF data</div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Fixed Footer with Thumbnails -->
  <footer class="flex-shrink-0 bg-black/90 backdrop-blur-sm border-t border-gray-700/50">
    <div class="px-4 py-1">
      <!-- Action Buttons and Controls (centered above thumbnails) -->
      <div class="flex justify-between items-center mb-2">
        <!-- Face Rectangle Toggle -->
        <label class="flex items-center gap-2 text-sm text-yellow-500 cursor-pointer select-none">
          <input type="checkbox" 
                 data-action="change->image-viewer#toggleFaceRectangles"
                 data-image-viewer-target="faceRectangleToggle"
                 class="w-4 h-4 appearance-none bg-black/50 border-2 border-yellow-500 rounded checked:bg-yellow-500 focus:ring-yellow-500 focus:ring-offset-0">
          <span>Show Face Rectangle</span>
        </label>
        
        <!-- Action Buttons (Admin Only) -->
        <div class="flex justify-center gap-3">
        <% if current_user.admin? %>
        <%= form_with url: update_hero_gallery_path(@session.id), 
                      data: { 
                        turbo_frame: "_top",
                        action: "turbo:submit-end->image-viewer#heroSelected"
                      },
                      local: true do |f| %>
          <%= hidden_field_tag :photo_id, @photos.first&.id, data: { image_viewer_target: "heroInput" } %>
          <%= hidden_field_tag :hero_photo_id, @hero_photo&.id, data: { image_viewer_target: "heroPhotoId" } %>
          <%= f.submit "‚òÜ Select as Hero",
                       data: {
                         image_viewer_target: "heroButton",
                         hero_text: "‚òÖ Selected as Hero",
                         select_text: "‚òÜ Select as Hero",
                         action: "click->image-viewer#heroSelected"
                       },
                       class: "px-3 py-1 bg-gray-700/70 text-gray-300 font-semibold text-sm rounded-full hover:bg-gray-600/70 transition-colors cursor-pointer shadow-lg whitespace-nowrap" %>
        <% end %>
        
        <%= form_with url: reject_photo_gallery_path(@session.id), 
                      method: :patch,
                      data: { 
                        turbo_frame: "_top",
                        action: "turbo:submit-end->image-viewer#photoRejected"
                      },
                      local: true do |f| %>
          <%= hidden_field_tag :photo_id, @photos.first&.id, data: { image_viewer_target: "rejectInput" } %>
          <%= hidden_field_tag :show_rejected, @show_rejected %>
          <%= f.submit "üóëÔ∏è Reject",
                       data: {
                         image_viewer_target: "rejectButton",
                         rejected_text: "‚úÖ Rejected",
                         reject_text: "üóëÔ∏è Reject"
                       },
                       class: "px-3 py-1 bg-gray-700/70 text-gray-300 font-semibold text-sm rounded-full hover:bg-gray-600/70 transition-colors cursor-pointer shadow-lg whitespace-nowrap" %>
        <% end %>
        
        <button data-action="click->image-viewer#confirmSplit"
                data-image-viewer-target="splitButton"
                class="px-3 py-1 bg-gray-700/70 text-gray-300 font-semibold text-sm rounded-full hover:bg-gray-600/70 transition-colors cursor-pointer shadow-lg disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
          ‚úÇÔ∏è Split Session Here
        </button>
        <% end %>
        
        <!-- Download Buttons -->
        <%= link_to download_all_gallery_path(@session.id),
                    class: "px-3 py-1 bg-gray-700/70 text-gray-300 font-semibold text-sm rounded-full hover:bg-gray-600/70 transition-colors cursor-pointer shadow-lg whitespace-nowrap",
                    title: "Download all photos in this session as a ZIP file" do %>
          üì¶ Download All
        <% end %>
        
        <a href="#"
           data-action="click->image-viewer#downloadCurrentPhoto"
           data-image-viewer-target="downloadButton"
           class="px-3 py-1 bg-gray-700/70 text-gray-300 font-semibold text-sm rounded-full hover:bg-gray-600/70 transition-colors cursor-pointer shadow-lg whitespace-nowrap"
           title="Download the currently visible photo">
          üíæ Download Photo
        </a>
        </div>

        <!-- Image Counter (right aligned) -->
        <div class="text-sm text-gray-400" data-image-viewer-target="counter"><%= @initial_index + 1 %> / <%= @photos.length %></div>
      </div>
      
      <!-- Horizontal Thumbnail Strip -->
      <div class="flex gap-2 overflow-x-auto scrollbar-hide">
        <% @photos.each_with_index do |photo, index| %>
          <button data-action="click->image-viewer#goToImage"
                  data-index="<%= index %>"
                  data-photo-id="<%= photo.id %>"
                  data-rejected="<%= photo.rejected %>"
                  data-image-viewer-target="thumbnail"
                  class="flex-shrink-0 w-16 h-16 rounded overflow-hidden border-2 image-container <%= 
                    if @hero_photo&.id == photo.id
                      'border-yellow-500 border-4'
                    elsif index == @initial_index 
                      'border-red-500' 
                    else 
                      'border-gray-600' 
                    end 
                  %> hover:border-red-400 transition-colors">
            <% if photo.image.attached? %>
              <%= image_tag rails_blob_url(photo.image.variant(:thumb)), 
                            alt: "Thumbnail #{index + 1}",
                            loading: "lazy",
                            class: "w-full h-full object-cover" %>
            <% else %>
              <%= image_tag photo_path(path: photo.original_path.sub('/Users/jeremy/Desktop/OK-SHOCK-25/', ''), variant: 'thumb'), 
                            alt: "Thumbnail #{index + 1}",
                            loading: "lazy",
                            class: "w-full h-full object-cover" %>
            <% end %>
          </button>
        <% end %>
      </div>
    </div>
  </footer>
  
  <!-- Email Collection Overlay -->
  <div data-image-viewer-target="emailForm" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 w-96 max-w-sm mx-4">
      <h3 class="text-lg font-semibold text-white mb-4">Contact Information</h3>
      <%= form_with url: save_email_gallery_path(@session.id), 
                    data: { turbo_frame: "_top" } do |f| %>
        <div class="space-y-4">
          <%= f.text_field :name, 
                           placeholder: "Name (optional)",
                           value: @sitting&.name,
                           class: "w-full px-4 py-3 bg-black/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-500 focus:outline-none" %>
          <%= f.email_field :email, 
                            placeholder: "Email address",
                            value: @sitting&.email,
                            required: true,
                            class: "w-full px-4 py-3 bg-black/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-500 focus:outline-none" %>
        </div>
        <div class="mt-6 flex gap-3">
          <%= f.submit "Save", class: "flex-1 px-4 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-500 transition-colors cursor-pointer" %>
          <button type="button" 
                  data-action="click->image-viewer#hideEmailForm"
                  class="flex-1 px-4 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-500 transition-colors">
            Cancel
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>