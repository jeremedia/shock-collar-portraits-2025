<% content_for :title, "Face Detection Queue" %>
<% content_for :page_title, "Face Detection Queue" %>
<% content_for :page_subtitle, "Monitor and control face detection processing" %>

<%= render 'shared/oknotok_admin_layout' do %>
  <!-- Flash Messages -->
  <% if flash[:success] %>
    <div class="bg-green-900 border border-green-500 text-green-300 px-4 py-3 rounded mb-4">
      <%= flash[:success] %>
    </div>
  <% end %>

  <% if flash[:error] %>
    <div class="bg-red-900 border border-red-500 text-red-300 px-4 py-3 rounded mb-4">
      <%= flash[:error] %>
    </div>
  <% end %>

  <% if flash[:info] %>
    <div class="bg-blue-900 border border-blue-500 text-blue-300 px-4 py-3 rounded mb-4">
      <%= flash[:info] %>
    </div>
  <% end %>

  <!-- Face Detection Stats -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-500"><%= number_with_delimiter(@stats[:total_photos]) %></div>
      <div class="text-red-400 text-sm">Total Photos</div>
    </div>

    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-green-400">
        <%= number_with_delimiter(@stats[:processed_photos]) %>
      </div>
      <div class="text-gray-400 text-sm">
        Processed (<%= @stats[:processing_percentage] %>%)
      </div>
    </div>

    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-yellow-400"><%= number_with_delimiter(@stats[:unprocessed_photos]) %></div>
      <div class="text-gray-400 text-sm">Pending</div>
    </div>

    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-purple-400"><%= number_with_delimiter(@stats[:photos_with_faces]) %></div>
      <div class="text-gray-400 text-sm">With Faces</div>
    </div>

    <div class="oknotok-stat-card">
      <div class="text-3xl font-bold text-gray-500"><%= number_with_delimiter(@stats[:photos_without_faces]) %></div>
      <div class="text-gray-400 text-sm">No Faces</div>
    </div>
  </div>

  <!-- Queue Statistics -->
  <div class="oknotok-card mb-8">
    <h3 class="text-xl font-bold text-yellow-500 mb-6">Solid Queue Statistics</h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="text-center">
        <div class="text-3xl font-bold text-blue-400"><%= number_with_delimiter(@queue_stats[:pending_jobs] || 0) %></div>
        <div class="text-sm text-gray-400">Pending Jobs</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-green-400"><%= number_with_delimiter(@queue_stats[:finished_jobs] || 0) %></div>
        <div class="text-sm text-gray-400">Completed Jobs</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-red-400"><%= number_with_delimiter(@queue_stats[:failed_jobs] || 0) %></div>
        <div class="text-sm text-gray-400">Failed Jobs</div>
      </div>
    </div>

    <div class="pt-6 border-t border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="text-center">
          <div class="text-2xl font-bold text-purple-400"><%= number_with_delimiter(@queue_stats[:pending_face_jobs] || 0) %></div>
          <div class="text-sm text-gray-400">Pending Face Detection Jobs</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-orange-400"><%= number_with_delimiter(@queue_stats[:failed_face_jobs] || 0) %></div>
          <div class="text-sm text-gray-400">Failed Face Detection Jobs</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Controls -->
  <div class="oknotok-card mb-8">
    <h3 class="text-xl font-bold text-yellow-500 mb-6">Queue Controls</h3>

    <div class="flex flex-wrap gap-4">
      <%= form_with url: admin_enqueue_all_path, method: :post, local: true, class: "inline" do |form| %>
        <%= form.submit "Process All Unprocessed Photos (#{@stats[:unprocessed_photos]})",
            class: "px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded transition",
            data: { confirm: "This will enqueue #{@stats[:unprocessed_photos]} photos for face detection. Continue?" } %>
      <% end %>

      <% if @queue_stats[:failed_face_jobs] && @queue_stats[:failed_face_jobs] > 0 %>
        <%= form_with url: admin_retry_failed_path, method: :post, local: true, class: "inline" do |form| %>
          <%= form.submit "Retry Failed Jobs (#{@queue_stats[:failed_face_jobs]})",
              class: "px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded transition" %>
        <% end %>
      <% end %>

      <% if @queue_stats[:finished_jobs] && @queue_stats[:finished_jobs] > 0 %>
        <%= form_with url: admin_clear_completed_jobs_path, method: :post, local: true, class: "inline" do |form| %>
          <%= form.submit "Clear Completed Jobs (#{@queue_stats[:finished_jobs]})",
              class: "px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded transition",
              data: { confirm: "This will permanently remove #{@queue_stats[:finished_jobs]} completed jobs from the queue. Continue?" } %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="oknotok-card mb-8">
    <h4 class="text-xl font-bold text-yellow-500 mb-4">Face Detection Progress</h4>
    <div class="w-full bg-gray-800 rounded-full h-4 mb-4">
      <div class="bg-gradient-to-r from-yellow-500 to-red-500 h-4 rounded-full transition-all duration-500" style="width: <%= @stats[:processing_percentage] %>%"></div>
    </div>
    <div class="flex justify-between text-sm text-gray-400">
      <span><%= number_with_delimiter(@stats[:processed_photos]) %> processed</span>
      <span class="text-yellow-500 font-bold"><%= @stats[:processing_percentage] %>% complete</span>
      <span><%= number_with_delimiter(@stats[:unprocessed_photos]) %> remaining</span>
    </div>
  </div>

  <!-- Recent Face Detection Jobs -->
  <% if @recent_face_jobs.any? %>
    <div class="oknotok-card mb-8">
      <h3 class="text-xl font-bold text-yellow-500 mb-6">Recent Face Detection Jobs</h3>

      <div class="overflow-x-auto">
        <table class="oknotok-table">
          <thead>
            <tr>
              <th class="text-left py-2">Photo ID</th>
              <th class="text-left py-2">Status</th>
              <th class="text-left py-2">Created</th>
              <th class="text-left py-2">Finished</th>
              <th class="text-left py-2">Duration</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_face_jobs.each do |job| %>
              <tr>
                <td class="py-2 text-gray-300">
                  <% if job.arguments.present? %>
                    Photo #<%= job.arguments.first %>
                  <% else %>
                    —
                  <% end %>
                </td>
                <td class="py-2">
                  <% if job.finished_at %>
                    <span class="px-2 py-1 text-xs font-semibold rounded bg-green-900 text-green-300">
                      Completed
                    </span>
                  <% else %>
                    <span class="px-2 py-1 text-xs font-semibold rounded bg-yellow-900 text-yellow-300">
                      Pending
                    </span>
                  <% end %>
                </td>
                <td class="py-2 text-gray-400 text-sm">
                  <%= job.created_at.strftime("%Y-%m-%d %H:%M:%S") %>
                </td>
                <td class="py-2 text-gray-400 text-sm">
                  <%= job.finished_at&.strftime("%Y-%m-%d %H:%M:%S") || "—" %>
                </td>
                <td class="py-2 text-gray-400 text-sm">
                  <% if job.finished_at && job.created_at %>
                    <%= ((job.finished_at - job.created_at) / 1.minute).round(2) %>min
                  <% else %>
                    —
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Failed Face Detection Jobs -->
  <% if @failed_face_jobs.any? %>
    <div class="oknotok-card border-red-600 mb-8">
      <h3 class="text-xl font-bold text-red-500 mb-6">Failed Face Detection Jobs</h3>

      <div class="overflow-x-auto">
        <table class="oknotok-table">
          <thead>
            <tr>
              <th class="text-left py-2">Photo ID</th>
              <th class="text-left py-2">Error</th>
              <th class="text-left py-2">Failed At</th>
            </tr>
          </thead>
          <tbody>
            <% @failed_face_jobs.each do |failed_job| %>
              <tr>
                <td class="py-2 text-gray-300">
                  <% if failed_job.job.arguments.present? %>
                    Photo #<%= failed_job.job.arguments.first %>
                  <% else %>
                    —
                  <% end %>
                </td>
                <td class="py-2 text-red-400 text-sm max-w-xs">
                  <div class="truncate" title="<%= failed_job.error %>">
                    <%= failed_job.error.to_s.first(80) %><%= "..." if failed_job.error.to_s.length > 80 %>
                  </div>
                </td>
                <td class="py-2 text-gray-400 text-sm">
                  <%= failed_job.created_at.strftime("%Y-%m-%d %H:%M:%S") %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Auto-refresh indicator -->
  <div class="text-center text-gray-500 text-sm mt-8">
    <span class="inline-flex items-center">
      <svg class="animate-spin h-4 w-4 mr-2 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Auto-refreshing every 15 seconds
    </span>
  </div>

  <!-- Auto-refresh script -->
  <script>
    // Auto-refresh every 15 seconds for more real-time monitoring
    setTimeout(function() {
      window.location.reload();
    }, 15000);
  </script>
<% end %>