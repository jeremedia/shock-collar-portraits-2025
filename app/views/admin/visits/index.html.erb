<div class="min-h-screen bg-black text-white p-4 lg:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-yellow-500 mb-2">üëÅÔ∏è Visitor Analytics</h1>
      <p class="text-gray-400">Watching the watchers of your portraits</p>
    </div>

    <!-- Live Activity Ticker -->
    <div class="bg-gradient-to-r from-purple-900/20 to-pink-900/20 border border-purple-500 rounded-lg p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-purple-400">
          <span class="inline-block animate-pulse">üî¥</span> Live Activity Feed
        </h2>
        <span class="text-sm text-gray-400">Last hour</span>
      </div>
      <div class="space-y-2 max-h-32 overflow-y-auto" id="live-feed">
        <% @live_events.first(10).each do |event| %>
          <div class="text-xs flex items-center gap-2 text-gray-300">
            <span class="text-gray-500"><%= event.time.strftime("%H:%M") %></span>
            <% if event.user %>
              <span class="text-purple-400"><%= event.user.email.split('@').first %></span>
            <% else %>
              <span class="text-gray-500">Anonymous</span>
            <% end %>
            <span class="text-yellow-300">‚Üí</span>
            <span><%= humanize_event(event) %></span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Current Visitors -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-green-400 mb-4">
          üü¢ Currently Online (<%= @active_visitors.count %>)
        </h2>
        <div class="space-y-3 max-h-64 overflow-y-auto">
          <% @active_visitors.each do |visit| %>
            <div class="flex justify-between items-start p-3 bg-gray-800 rounded">
              <div>
                <div class="font-semibold">
                  <% if visit.user %>
                    <%= visit.user.email %>
                  <% else %>
                    <span class="text-gray-500">Anonymous Visitor</span>
                  <% end %>
                </div>
                <div class="text-sm text-gray-400">
                  <%= visit.browser %> on <%= visit.os %>
                  <% if visit.city.present? %>
                    ‚Ä¢ <%= visit.city %>, <%= visit.region %>
                  <% end %>
                </div>
                <div class="text-xs text-green-400">
                  Active <%= time_ago_in_words(visit.started_at) %> ago
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-yellow-500">
                  <%= visit.events.count %>
                </div>
                <div class="text-xs text-gray-400">actions</div>
              </div>
            </div>
          <% end %>
          <% if @active_visitors.empty? %>
            <p class="text-gray-500 text-center py-8">No active visitors right now</p>
          <% end %>
        </div>
      </div>

      <!-- Visitor Stats Overview -->
      <div class="bg-gray-900 border border-blue-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-blue-400 mb-4">üìä Visitor Overview</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-800 rounded p-4">
            <div class="text-3xl font-bold text-yellow-500"><%= @visitor_stats[:total] %></div>
            <div class="text-sm text-gray-400">Total Visitors</div>
          </div>
          <div class="bg-gray-800 rounded p-4">
            <div class="text-3xl font-bold text-green-400"><%= @visitor_stats[:returning] %></div>
            <div class="text-sm text-gray-400">Returning Visitors</div>
          </div>
          <div class="bg-gray-800 rounded p-4">
            <div class="text-3xl font-bold text-purple-400"><%= @visitor_stats[:return_rate] %>%</div>
            <div class="text-sm text-gray-400">Return Rate</div>
          </div>
          <div class="bg-gray-800 rounded p-4">
            <div class="text-3xl font-bold text-orange-400"><%= @engagement[:avg_events_per_visit] %></div>
            <div class="text-sm text-gray-400">Actions/Visit</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Most Viewed Photos -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-gray-900 border border-orange-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-orange-400 mb-4">üî• Hot Photos (24h)</h2>
        <div class="space-y-2">
          <% @popular_photos_today.each_with_index do |(photo, count), i| %>
            <div class="flex items-center gap-3">
              <span class="text-2xl font-bold text-gray-600">#<%= i + 1 %></span>
              <div class="flex-1">
                <div class="font-semibold">
                  Session <%= photo.photo_session&.session_number || "?" %>
                  <% if photo.sitting %>
                    - <%= photo.sitting.name || photo.sitting.email %>
                  <% end %>
                </div>
                <div class="text-sm text-gray-400">
                  Photo #<%= photo.position %> ‚Ä¢ <%= photo.created_at.strftime("%b %d") %>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold text-orange-400"><%= count %></div>
                <div class="text-xs text-gray-400">views</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="bg-gray-900 border border-yellow-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-yellow-400 mb-4">üëë Hall of Fame (All Time)</h2>
        <div class="space-y-2">
          <% @popular_photos_all_time.each_with_index do |(photo, count), i| %>
            <div class="flex items-center gap-3">
              <span class="text-2xl font-bold text-gray-600">#<%= i + 1 %></span>
              <div class="flex-1">
                <div class="font-semibold">
                  Session <%= photo.photo_session&.session_number || "?" %>
                  <% if photo.sitting %>
                    - <%= photo.sitting.name || photo.sitting.email %>
                  <% end %>
                </div>
                <div class="text-sm text-gray-400">
                  Photo #<%= photo.position %> ‚Ä¢ <%= photo.created_at.strftime("%b %d") %>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold text-yellow-400"><%= count %></div>
                <div class="text-xs text-gray-400">views</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Most Active Visitors -->
    <div class="bg-gray-900 border border-red-600 rounded-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-red-400 mb-4">üèÜ Power Users</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <% @top_visitors.each_with_index do |visitor, i| %>
          <div class="flex items-center gap-3 p-3 bg-gray-800 rounded hover:bg-gray-700 cursor-pointer"
               data-visitor-id="<%= visitor.id %>" onclick="loadVisitorDetail(<%= visitor.id %>)">
            <div class="text-3xl">
              <%= case i
                when 0 then "ü•á"
                when 1 then "ü•à"
                when 2 then "ü•â"
                else "#{i + 1}."
              end %>
            </div>
            <div class="flex-1">
              <div class="font-semibold"><%= visitor.email %></div>
              <div class="text-sm text-gray-400">
                <% if visitor.name.present? %>
                  <%= visitor.name %> ‚Ä¢
                <% end %>
                Last seen <%= time_ago_in_words(visitor.last_seen) %> ago
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-red-400"><%= visitor.visit_count %></div>
              <div class="text-xs text-gray-400">visits</div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Activity Heatmap -->
    <div class="bg-gray-900 border border-cyan-600 rounded-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-cyan-400 mb-4">üóìÔ∏è Activity Heatmap (Last 7 Days)</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr>
              <th class="text-left py-2">Day</th>
              <% 24.times do |hour| %>
                <th class="px-1"><%= hour %></th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% %w[Sun Mon Tue Wed Thu Fri Sat].each_with_index do |day, d| %>
              <tr>
                <td class="py-1 pr-2 font-semibold"><%= day %></td>
                <% 24.times do |h| %>
                  <% intensity = @activity_heatmap[d][h] %>
                  <% bg_class = case intensity
                    when 0 then "bg-gray-800"
                    when 1..5 then "bg-green-900"
                    when 6..15 then "bg-green-700"
                    when 16..30 then "bg-green-500"
                    else "bg-green-300"
                  end %>
                  <td class="p-1">
                    <div class="w-4 h-4 <%= bg_class %> rounded" title="<%= intensity %> events"></div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Session Depth Analysis -->
    <div class="grid lg:grid-cols-3 gap-6 mb-8">
      <div class="bg-gray-900 border border-purple-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-purple-400 mb-4">üì∏ Engagement Depth</h2>
        <div class="space-y-2">
          <% @session_depths.sort_by { |k, _| k.split(/\D+/).first.to_i }.each do |bucket, count| %>
            <div class="flex justify-between items-center">
              <span class="text-sm"><%= bucket %></span>
              <div class="flex items-center gap-2">
                <div class="bg-purple-600 h-2 rounded" style="width: <%= (count * 100.0 / @session_depths.values.max) %>%"></div>
                <span class="text-sm font-bold"><%= count %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="bg-gray-900 border border-pink-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-pink-400 mb-4">üåç Top Locations</h2>
        <div class="space-y-2 max-h-64 overflow-y-auto">
          <% @visitor_locations.first(10).each do |(location, count)| %>
            <div class="flex justify-between items-center">
              <span class="text-sm"><%= location.join(", ") %></span>
              <span class="text-sm font-bold text-pink-400"><%= count %></span>
            </div>
          <% end %>
        </div>
      </div>

      <div class="bg-gray-900 border border-teal-600 rounded-lg p-6">
        <h2 class="text-xl font-bold text-teal-400 mb-4">üì± Devices</h2>
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-400 mb-1">Device Type</div>
            <% @devices.each do |device, count| %>
              <div class="flex justify-between text-sm">
                <span><%= device || "Unknown" %></span>
                <span class="font-bold"><%= count %></span>
              </div>
            <% end %>
          </div>
          <div>
            <div class="text-sm text-gray-400 mb-1">Browsers</div>
            <% @browsers.sort_by { |_, c| -c }.first(5).each do |browser, count| %>
              <div class="flex justify-between text-sm">
                <span><%= browser || "Unknown" %></span>
                <span class="font-bold"><%= count %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Paths -->
    <% if @common_paths.any? %>
      <div class="bg-gray-900 border border-indigo-600 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-indigo-400 mb-4">üõ§Ô∏è Common Journey Paths</h2>
        <div class="space-y-3">
          <% @common_paths.each do |path, count| %>
            <div class="p-3 bg-gray-800 rounded">
              <div class="text-sm font-mono text-indigo-300"><%= path %></div>
              <div class="text-xs text-gray-400">Followed by <%= count %> visitors</div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Back Link -->
    <div class="mt-8">
      <%= link_to "‚Üê Back to Admin Dashboard", admin_dashboard_path,
          class: "text-yellow-500 hover:text-yellow-400 transition" %>
    </div>
  </div>
</div>

<!-- Visitor Detail Modal -->
<div id="visitor-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
  <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div id="visitor-modal-content"></div>
  </div>
</div>

<script>
function loadVisitorDetail(visitorId) {
  const modal = document.getElementById('visitor-modal');
  const content = document.getElementById('visitor-modal-content');

  modal.classList.remove('hidden');
  content.innerHTML = '<div class="p-8 text-center"><div class="animate-spin text-4xl">‚è≥</div></div>';

  fetch(`/admin/visits/${visitorId}/visitor_detail`)
    .then(response => response.text())
    .then(html => {
      content.innerHTML = html;
    })
    .catch(error => {
      console.error('Error loading visitor details:', error);
      content.innerHTML = '<div class="p-8 text-center text-red-400">Failed to load visitor details</div>';
    });
}

document.getElementById('visitor-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    this.classList.add('hidden');
  }
});

// Auto-refresh live feed every 30 seconds
setInterval(() => {
  location.reload();
}, 30000);
</script>