<% content_for :title, "Admin Dashboard" %>
<% content_for :page_title, "Admin Dashboard" %>
<% content_for :page_subtitle, "OKNOTOK Shock Collar Portraits - Burning Man 2025" %>

<%= render 'shared/oknotok_admin_layout' do %>
  <!-- Primary Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <div class="oknotok-stat-card text-center">
      <div class="text-5xl font-bold text-yellow-500 mb-2"><%= @stats[:total_sessions] %></div>
      <div class="text-gray-400 text-xs uppercase tracking-wider">Total Sessions</div>
    </div>

    <div class="oknotok-stat-card text-center">
      <div class="text-5xl font-bold text-yellow-500 mb-2"><%= number_with_delimiter(@stats[:total_photos]) %></div>
      <div class="text-gray-400 text-xs uppercase tracking-wider">Total Photos</div>
    </div>

    <div class="oknotok-stat-card text-center">
      <div class="text-5xl font-bold text-yellow-500 mb-2"><%= @stats[:total_sittings] %></div>
      <div class="text-gray-400 text-xs uppercase tracking-wider">Emails Collected</div>
    </div>
  </div>

  <!-- Secondary Stats -->
  <div class="grid grid-cols-2 gap-4 mb-8">
    <div class="oknotok-stat-card flex items-center justify-between">
      <div>
        <div class="text-2xl font-bold text-red-400"><%= @stats[:sessions_with_sittings] %></div>
        <div class="text-gray-500 text-xs uppercase">Sessions with Email</div>
      </div>
      <div class="text-3xl opacity-20">üìß</div>
    </div>

    <div class="oknotok-stat-card flex items-center justify-between">
      <div>
        <div class="text-2xl font-bold text-red-400"><%= @stats[:sessions_without_sittings] %></div>
        <div class="text-gray-500 text-xs uppercase">Sessions without Email</div>
      </div>
      <div class="text-3xl opacity-20">üì∑</div>
    </div>
  </div>

  <!-- Visitor Stats -->
  <div class="oknotok-card mb-8">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">üëÅÔ∏è Visitor Analytics</h2>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500"><%= number_with_delimiter(@visitor_stats[:total_visits]) %></div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">Total Visits</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500"><%= number_with_delimiter(@visitor_stats[:total_unique_visitors]) %></div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">Unique Visitors</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500"><%= @visitor_stats[:visits_today] %></div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">Today</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500"><%= @visitor_stats[:visits_this_week] %></div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">This Week</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-3xl font-bold text-yellow-500"><%= @visitor_stats[:logged_in_visitors] %></div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">Logged In Users</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4">
        <% conversion_rate = @visitor_stats[:total_unique_visitors] > 0 ?
           ((@visitor_stats[:logged_in_visitors].to_f / @visitor_stats[:total_unique_visitors]) * 100).round(1) : 0 %>
        <div class="text-3xl font-bold text-yellow-500"><%= conversion_rate %>%</div>
        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1">Login Rate</div>
      </div>
    </div>

    <!-- Recent Visits -->
    <% if @visitor_stats[:recent_visits].any? %>
      <div class="mt-6">
        <h3 class="text-lg font-semibold text-yellow-500 mb-4">Recent Visits</h3>
        <div class="space-y-2">
          <% @visitor_stats[:recent_visits].first(5).each do |visit| %>
            <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg hover:bg-gray-750 transition">
              <div class="flex items-center gap-4">
                <span class="text-sm font-mono text-gray-400"><%= visit.started_at.strftime("%H:%M") %></span>
                <% if visit.user %>
                  <span class="text-yellow-500 font-medium">üë§ <%= visit.user.email.split('@').first %></span>
                <% else %>
                  <span class="text-gray-500">üîí Anonymous</span>
                <% end %>
              </div>
              <div class="text-xs text-gray-500 uppercase tracking-wider">
                <%= visit.device_type || 'Unknown' %> ‚Ä¢ <%= visit.browser || 'Unknown' %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Photo Management -->
    <div class="oknotok-card">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">üì∏ Photo Management</h3>
      <div class="space-y-3">
        <%= link_to gallery_index_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Gallery View</div>
          <div class="text-sm text-gray-400">Browse all photos by session</div>
        <% end %>
      </div>
    </div>

    <!-- Processing Tools -->
    <div class="oknotok-card">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">‚öôÔ∏è Processing Tools</h3>
      <div class="space-y-3">
        <%= link_to admin_face_detection_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Face Detection</div>
          <div class="text-sm text-gray-400">Process photos for face rectangles</div>
        <% end %>
        <%= link_to admin_exif_config_index_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">EXIF Configuration</div>
          <div class="text-sm text-gray-400">Configure which photo metadata to display</div>
        <% end %>
        <%= link_to admin_queue_status_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Job Queue Status</div>
          <div class="text-sm text-gray-400">Monitor background processing</div>
        <% end %>
      </div>
    </div>

    <!-- Data & Reports -->
    <div class="oknotok-card">
    <h3 class="text-xl font-bold text-yellow-500 mb-4">üìä Data & Reports</h3>
    <div class="space-y-3">
        <%= link_to stats_path, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Statistics Dashboard</div>
          <div class="text-sm text-gray-400">Charts and analytics</div>
        <% end %>
        <%= link_to admin_export_emails_path, format: :csv, class: "block p-3 bg-gray-800 hover:bg-gray-700 rounded transition" do %>
          <div class="font-semibold text-white">Export Emails CSV</div>
          <div class="text-sm text-gray-400"><%= @stats[:total_sittings] %> unique emails collected</div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Stats Cache Tools -->
  <div class="oknotok-card mb-8">
    <h3 class="text-xl font-bold text-yellow-500 mb-4">üßä Stats Cache</h3>
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-400">Version</div>
        <div class="font-mono text-white"><%= @stats_version %></div>
        <div class="text-sm text-gray-400 mt-2">Last Updated</div>
        <div class="text-white"><%= @stats_last_updated&.strftime('%Y-%m-%d %H:%M:%S') || '-' %></div>
      </div>
      <div class="flex flex-col gap-2">
        <%= button_to "Warm Stats Cache", admin_warm_stats_cache_path, method: :post,
              class: "oknotok-button-primary" %>
        <%= link_to "View Stats (force refresh)", stats_path(refresh: 1),
              class: "oknotok-button-secondary text-center" %>
      </div>
    </div>
  </div>

  <!-- Sessions by Day -->
  <div class="oknotok-card mb-8">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">üìÖ Sessions by Day</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <% @days.each do |day| %>
        <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition">
          <div class="font-bold text-yellow-500 capitalize"><%= day.day_name %></div>
          <div class="text-xs text-gray-400 uppercase tracking-wider"><%= day.date.strftime('%b %d') %></div>
          <div class="text-3xl font-bold text-white mt-2"><%= day.photo_sessions.visible.count %></div>
          <div class="text-xs text-gray-500 uppercase">sessions</div>
          <div class="text-sm text-gray-500 mt-2">
            <%= day.photo_sessions.visible.sum { |ps| ps.photo_count || 0 } %> photos
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="oknotok-card">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-yellow-500">üìß Recent Email Collections</h2>
      <div class="flex gap-2">
        <%= link_to "View All", admin_sittings_path, 
            class: "oknotok-button-secondary text-sm" %>
        <%= link_to "Export CSV", admin_export_emails_path(format: :csv), 
            class: "oknotok-button-primary text-sm" %>
      </div>
    </div>
    
    <% if @recent_sittings.any? %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Session</th>
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Day</th>
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Name</th>
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Email</th>
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Notes</th>
              <th class="text-left py-3 px-2 text-xs text-gray-400 uppercase tracking-wider">Time</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_sittings.each do |sitting| %>
              <tr class="border-b border-gray-800 hover:bg-gray-800 transition">
                <td class="py-3 px-2 text-white font-medium">
                  <% if sitting.photo_session.burst_id.start_with?('placeholder_') %>
                    <span class="text-gray-500 text-sm">CSV Import</span>
                  <% else %>
                    #<%= sitting.photo_session.session_number %>
                  <% end %>
                </td>
                <td class="py-3 px-2 text-gray-300 capitalize text-sm">
                  <%= sitting.photo_session.session_day.day_name %>
                </td>
                <td class="py-3 px-2 text-gray-300"><%= sitting.name || '-' %></td>
                <td class="py-3 px-2 text-yellow-500 font-medium"><%= sitting.email %></td>
                <td class="py-3 px-2 text-gray-500 text-sm"><%= truncate(sitting.notes || '-', length: 30) %></td>
                <td class="py-3 px-2 text-gray-500 text-sm font-mono">
                  <%= sitting.created_at.strftime('%b %d %H:%M') %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-400">No email collections yet.</p>
    <% end %>
  </div>

  <!-- Admin Tools -->
  <% if current_user&.superadmin? %>
    <div class="mt-8 p-6 bg-gradient-to-r from-red-900 to-yellow-900 border border-red-600 rounded-lg">
      <h3 class="text-xl font-bold text-yellow-500 mb-4">üîß Superadmin Tools</h3>
      <div class="flex flex-wrap gap-4">
        <%= link_to "Manage Admins", admin_invites_path, 
            class: "px-4 py-2 bg-black text-yellow-500 hover:bg-gray-900 rounded transition" %>
        <%= link_to "Bulk Invite Users", "#", 
            onclick: "if(confirm('Run rails emails:bulk_invite to send invitations to all collected emails')) { alert('Run this command in terminal'); } return false;",
            class: "px-4 py-2 bg-black text-yellow-500 hover:bg-gray-900 rounded transition" %>
      </div>
    </div>
  <% end %>
<% end %>
